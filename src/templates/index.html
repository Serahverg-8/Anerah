<!DOCTYPE html>
<html>
<head>
  <title>Sleep Soundscape AI Demo</title>
</head>
<body>
  <h2>Sleep Soundscape AI Demo</h2>
  <label>Mood before bed:
    <input id="mood" placeholder="e.g. tired, stressed" />
  </label>
  <button id="startBtn">Start Sleep Session</button>
  <button id="endBtn" disabled>End Session</button>

  <table border="1" cellpadding="8" cellspacing="0" style="margin-top:20px;">
    <thead>
      <tr>
        <th>Timestamp (sec)</th>
        <th>Predicted Stage</th>
        <th>Ground Truth Stage</th>
        <th>Suggested Sound</th>
        <th>Reasoning</th>
      </tr>
    </thead>
    <tbody id="resultsBody"></tbody>
  </table>

  <script>
    let simulatedData = [];

    // Load simulated data from external JSON file in /static/data/
    fetch('/static/data/sim_oura_wo_stages.json')
      .then(res => res.json())
      .then(json => {
          simulatedData = json;
          console.log('Simulated data loaded', simulatedData);
      })
      .catch(err => {
          alert('Failed to load simulated data: ' + err);
      });

    let intervalId;
    let index = 0;
    let mood = "";  // mood input captured on session start

    document.getElementById("startBtn").onclick = () => {
      mood = document.getElementById("mood").value.trim();
      if (!mood) {
        alert("Please enter your mood before starting.");
        return;
      }
      if (simulatedData.length === 0) {
        alert("Data not loaded yet, please wait.");
        return;
      }

      index = 0;
      document.getElementById("resultsBody").innerHTML = "";
      document.getElementById("startBtn").disabled = true;
      document.getElementById("endBtn").disabled = false;

      intervalId = setInterval(() => {
        if (index >= simulatedData.length) {
          clearInterval(intervalId);
          document.getElementById("startBtn").disabled = false;
          document.getElementById("endBtn").disabled = true;
          return;
        }

        // Prepare data for API, include mood
        const data = {...simulatedData[index], mood};

        fetch("/predict_stage", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        })
          .then(res => res.json())
          .then(json => {
            const tbody = document.getElementById("resultsBody");
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${json.timestamp_sec || "N/A"}</td>
              <td>${json.stage || json.predicted_stage || "N/A"}</td>
              <td>${json.ground_truth_stage || "N/A"}</td>
              <td>${json.sound || "N/A"}</td>
              <td>${json.explanation || json.reasoning || "N/A"}</td>
            `;
            tbody.appendChild(tr);
            index++;
          })
          .catch(err => {
            alert("Error fetching prediction: " + err);
            clearInterval(intervalId);
            document.getElementById("startBtn").disabled = false;
            document.getElementById("endBtn").disabled = true;
          });
      }, 15000); // update every 15 seconds
    };

    document.getElementById("endBtn").onclick = () => {
      clearInterval(intervalId);
      document.getElementById("startBtn").disabled = false;
      document.getElementById("endBtn").disabled = true;
    };
  </script>
</body>
</html>
